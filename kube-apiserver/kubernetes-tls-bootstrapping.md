# + 配置 TLS bootstrapping

# 参考地址 :  https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping/

```yaml
---
# enable bootstrapping nodes to create CSR
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: create-csrs-for-kubelet-bootstrapping
subjects:
- kind: Group
  name: system:bootstrappers
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: ClusterRole
  name: system:node-bootstrapper
  apiGroup: rbac.authorization.k8s.io
---
# Approve all CSRs for the group "system:bootstrappers"
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: auto-approve-csrs-for-group
subjects:
- kind: Group
  name: system:bootstrappers
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: ClusterRole
  name: system:certificates.k8s.io:certificatesigningrequests:nodeclient
  apiGroup: rbac.authorization.k8s.io
---
# Approve renewal CSRs for the group "system:nodes"
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: auto-approve-renewals-for-nodes
subjects:
- kind: Group
  name: system:nodes
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: ClusterRole
  name: system:certificates.k8s.io:certificatesigningrequests:selfnodeclient
  apiGroup: rbac.authorization.k8s.io

```
```shell
# kubectl apply -f tls-boots.yaml
clusterrolebinding.rbac.authorization.k8s.io/create-csrs-for-kubelet-bootstrapping created
clusterrolebinding.rbac.authorization.k8s.io/auto-approve-csrs-for-group created
clusterrolebinding.rbac.authorization.k8s.io/auto-approve-renewals-for-nodes created
# 创建token 参考
# https://kubernetes.io/docs/reference/access-authn-authz/bootstrap-tokens/
# head -c 16 /dev/urandom | od -An -t x | tr -d ' '
c3c5c644b85b9709030bfae5190fce1a
# Token Format c3c5c6.44b85b9709030bfa
```

```yaml
# 示例
apiVersion: v1
kind: Secret
metadata:
  # Name MUST be of form "bootstrap-token-<token id>"
  name: bootstrap-token-07401b
  namespace: kube-system

# Type MUST be 'bootstrap.kubernetes.io/token'
type: bootstrap.kubernetes.io/token
stringData:
  # Human readable description. Optional.
  description: "The default bootstrap token generated by 'kubeadm init'."

  # Token ID and secret. Required.
  token-id: 07401b
  token-secret: f395accd246ae52d

  # Expiration. Optional.
  expiration: 2017-03-10T03:22:11Z

  # Allowed usages.
  usage-bootstrap-authentication: "true"
  usage-bootstrap-signing: "true"

  # Extra groups to authenticate the token as. Must start with "system:bootstrappers:"
  auth-extra-groups: system:bootstrappers:worker,system:bootstrappers:ingress
```

```shell
# cat bootstrap-token.yaml
apiVersion: v1
kind: Secret
metadata:
  # Name MUST be of form "bootstrap-token-<token id>"
  name: bootstrap-token-c3c5c6
  namespace: kube-system

# Type MUST be 'bootstrap.kubernetes.io/token'
type: bootstrap.kubernetes.io/token
stringData:
  # Human readable description. Optional.
  description: "The default bootstrap token generated by 'kubelet'."

  # Token ID and secret. Required.
  token-id: c3c5c6
  token-secret: 44b85b9709030bfa

  # Allowed usages.
  usage-bootstrap-authentication: "true"
  usage-bootstrap-signing: "true"

  # Extra groups to authenticate the token as. Must start with "system:bootstrappers:"
  auth-extra-groups: system:bootstrappers:worker,system:bootstrappers:ingress
# kubectl apply -f bootstrap-token.yaml
secret/bootstrap-token-c3c5c6 created
```

```shell
# cat kube-api-to-kueblet.yaml 
# kubectl apply -f kube-api-to-kueblet.yaml
clusterrole.rbac.authorization.k8s.io/system:kube-apiserver-to-kubelet created
clusterrolebinding.rbac.authorization.k8s.io/system:kube-apiserver created
```

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  annotations:
    rbac.authorization.kubernetes.io/autoupdate: "true"
  labels:
    kubernetes.io/bootstrapping: rbac-defaults
  name: system:kube-apiserver-to-kubelet
rules:
  - apiGroups:
      - ""
    resources:
      - nodes/proxy
      - nodes/stats
      - nodes/log
      - nodes/spec
      - nodes/metrics
    verbs:
      - "*"
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: system:kube-apiserver
  namespace: ""
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:kube-apiserver-to-kubelet
subjects:
  - apiGroup: rbac.authorization.k8s.io
    kind: User
    name: kube-apiserver
```

```shell
# 生成bootstrap-kubelet.kubeconfig
# cd /data/applications/kubernetes-v1.19.10/server/certs/
kubectl config set-cluster kubernetes     --certificate-authority=kubernetes-ca.pem     --embed-certs=true     --server=https://172.16.100.69:8443     --kubeconfig=/data/applications/kubernetes-v1.19.10/server/conf/bootstrap-kubelet.kubeconfig

# kubectl config set-cluster kubernetes     --certificate-authority=kubernetes-ca.pem     --embed-certs=true     --server=https://172.16.100.69:8443     --kubeconfig=/data/applications/kubernetes-v1.19.10/server/conf/bootstrap-kubelet.kubeconfig
Cluster "kubernetes" set.

kubectl config set-credentials tls-bootstrap-token-kubelet     --token=c3c5c6.44b85b9709030bfa --kubeconfig=/data/applications/kubernetes-v1.19.10/server/conf/bootstrap-kubelet.kubeconfig

# kubectl config set-credentials tls-bootstrap-token-kubelet     --token=c3c5c6.44b85b9709030bfa --kubeconfig=/data/applications/kubernetes-v1.19.10/server/conf/bootstrap-kubelet.kubeconfig
User "tls-bootstrap-token-kubelet" set.

kubectl config set-context tls-bootstrap-token-kubelet@kubernetes     --cluster=kubernetes     --user=tls-bootstrap-token-kubelet    --kubeconfig=/data/applications/kubernetes-v1.19.10/server/conf/bootstrap-kubelet.kubeconfig

# kubectl config set-context tls-bootstrap-token-kubelet@kubernetes     --cluster=kubernetes     --user=tls-bootstrap-token-kubelet    --kubeconfig=/data/applications/kubernetes-v1.19.10/server/conf/bootstrap-kubelet.kubeconfig
Context "tls-bootstrap-token-kubelet@kubernetes" created.

kubectl config use-context tls-bootstrap-token-kubelet@kubernetes     --kubeconfig=/data/applications/kubernetes-v1.19.10/server/conf/bootstrap-kubelet.kubeconfig

# kubectl config use-context tls-bootstrap-token-kubelet@kubernetes     --kubeconfig=/data/applications/kubernetes-v1.19.10/server/conf/bootstrap-kubelet.kubeconfig
Switched to context "tls-bootstrap-token-kubelet@kubernetes".
```